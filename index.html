<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Iniciar sesión</title>
<style>
    /* Estilos CSS existentes omitidos por brevedad */
</style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <h2>Iniciar sesión</h2>
        <form id="loginForm" action="#" method="post" onsubmit="return validateForm()">
            <input type="text" id="username" name="username" placeholder="Nombre de usuario" required><br>
            <input type="password" id="password" name="password" placeholder="Contraseña" required><br>
            <input type="submit" value="Iniciar sesión">
        </form>
        <p id="message"></p>
    </div>

    <div class="overlay-container" id="overlayContainer">
        <div class="overlay-box">
            <h3>Opción 1</h3>
            <div id="chatContainer">
                <main>
                    <ul id="messages"></ul>
                </main>
                <form id="chatForm">
                    <input type="text" id="userInput" placeholder="Escribe tu mensaje aquí...">
                    <button type="submit">Enviar</button>
                </form>
                <small>&nbsp;</small>
                <template id="messageTemplate">
                    <li class="message">
                        <span></span>
                        <p></p>
                    </li>
                </template>
            </div>
        </div>
        <!-- Otros overlay-box omitidos por brevedad -->
    </div>

    <script type="module" src="script.js"></script>
    <script type="module">
        import { CreateWebWorkerMLCEngine } from "https://cdn.jsdelivr.net/npm/@mlc-ai/web-llm@0.2.46/+esm";

        const $ = el => document.querySelector(el);
        const $messages = $('#messages');
        const $chatForm = $('#chatForm');
        const $userInput = $('#userInput');
        const $template = $('#messageTemplate');
        const $chatContainer = $('#chatContainer');
        const $button = $('button');
        const $info = $('small');
        const $loading = $('.loading');

        let messages = [];
        let end = false;

        const SELECTED_MODEL = 'Llama-3-8B-Instruct-q4f32_1-MLC-1k';

        async function initChat() {
            const engine = await CreateWebWorkerMLCEngine(
                new Worker('./worker.js', { type: 'module' }),
                SELECTED_MODEL,
                {
                    initProgressCallback: (info) => {
                        $info.textContent = info.text;
                        if (info.progress === 1 && !end) {
                            end = true;
                            $loading?.parentNode?.removeChild($loading);
                            $button.removeAttribute('disabled');
                            addMessage("¡Hola! Soy un ChatGPT que se ejecuta completamente en tu navegador. ¿En qué puedo ayudarte hoy?", 'bot');
                            $userInput.focus();
                        }
                    }
                }
            );

            $chatForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const messageText = $userInput.value.trim();

                if (messageText !== '') {
                    $userInput.value = '';
                }

                addMessage(messageText, 'user');
                $button.setAttribute('disabled', '');

                messages.push({ role: 'user', content: messageText });

                const chunks = await engine.chat.completions.create({
                    messages,
                    stream: true
                });

                let reply = '';

                for await (const chunk of chunks) {
                    const choice = chunk.choices[0];
                    const content = choice?.delta?.content ?? '';
                    reply += content;
                }

                addMessage(reply, 'bot');
                messages.push({ role: 'assistant', content: reply });
                $chatContainer.scrollTop = $chatContainer.scrollHeight;

                $button.removeAttribute('disabled');
            });

            function addMessage(text, sender) {
                const clonedTemplate = $template.content.cloneNode(true);
                const $newMessage = clonedTemplate.querySelector('.message');
                const $who = $newMessage.querySelector('span');
                const $text = $newMessage.querySelector('p');

                $text.textContent = text;
                $who.textContent = sender === 'bot' ? 'GPT' : 'Tú';
                $newMessage.classList.add(sender);
                $messages.appendChild($newMessage);
                $chatContainer.scrollTop = $chatContainer.scrollHeight;

                return $text;
            }
        }

        initChat().catch(err => console.error('Error inicializando el chat:', err));
    </script>
</body>
</html>

